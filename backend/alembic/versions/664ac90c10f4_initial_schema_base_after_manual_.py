"""Initial schema base after manual migration

Revision ID: 664ac90c10f4
Revises: 
Create Date: 2025-11-08 18:09:32.122000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '664ac90c10f4'
down_revision = None
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('next_div_map',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('from_customer', sa.Text(), nullable=False),
    sa.Column('from_next_div', sa.Text(), nullable=False),
    sa.Column('target_supplier', sa.Text(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.String(length=50), nullable=True),
    sa.Column('updated_by', sa.String(length=50), nullable=True),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.Column('revision', sa.Integer(), server_default='1', nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('from_customer', 'from_next_div', name='uq_next_div_map')
    )
    op.create_table('receipt_headers',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('receipt_no', sa.Text(), nullable=False),
    sa.Column('warehouse_id', sa.Integer(), nullable=False),
    sa.Column('supplier_code', sa.Text(), nullable=False),
    sa.Column('receipt_date', sa.Date(), nullable=False),
    sa.Column('status', sa.Text(), nullable=True),
    sa.Column('source_doc_no', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.String(length=50), nullable=True),
    sa.Column('updated_by', sa.String(length=50), nullable=True),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.Column('revision', sa.Integer(), server_default='1', nullable=False),
    sa.ForeignKeyConstraint(['supplier_code'], ['suppliers.supplier_code'], ),
    sa.ForeignKeyConstraint(['warehouse_id'], ['warehouses.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('receipt_no')
    )
    with op.batch_alter_table('receipt_headers', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_receipt_headers_warehouse_id'), ['warehouse_id'], unique=False)

    op.create_table('product_uom_conversions',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('product_code', sa.Text(), nullable=False),
    sa.Column('source_unit', sa.Text(), nullable=False),
    sa.Column('source_value', sa.Float(), nullable=False),
    sa.Column('internal_unit_value', sa.Float(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.String(length=50), nullable=True),
    sa.Column('updated_by', sa.String(length=50), nullable=True),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.Column('revision', sa.Integer(), server_default='1', nullable=False),
    sa.ForeignKeyConstraint(['product_code'], ['products.product_code'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('product_code', 'source_unit', name='uq_product_uom')
    )
    op.create_table('receipt_lines',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('receipt_header_id', sa.Integer(), nullable=False),
    sa.Column('line_no', sa.Integer(), nullable=False),
    sa.Column('lot_id', sa.Integer(), nullable=False),
    sa.Column('product_code', sa.Text(), nullable=False),
    sa.Column('quantity', sa.Float(), nullable=False),
    sa.Column('unit', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.String(length=50), nullable=True),
    sa.Column('updated_by', sa.String(length=50), nullable=True),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.Column('revision', sa.Integer(), server_default='1', nullable=False),
    sa.ForeignKeyConstraint(['lot_id'], ['lots.id'], ),
    sa.ForeignKeyConstraint(['product_code'], ['products.product_code'], ),
    sa.ForeignKeyConstraint(['receipt_header_id'], ['receipt_headers.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('receipt_header_id', 'line_no', name='uq_receipt_line')
    )
    with op.batch_alter_table('receipt_lines', schema=None) as batch_op:
        batch_op.create_index('ix_receipt_lines_lot', ['lot_id'], unique=False)

    op.create_table('shipping',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('lot_id', sa.Integer(), nullable=False),
    sa.Column('order_line_id', sa.Integer(), nullable=True),
    sa.Column('shipped_quantity', sa.Numeric(precision=15, scale=4), nullable=False),
    sa.Column('shipping_date', sa.Date(), nullable=False),
    sa.Column('destination_code', sa.Text(), nullable=True),
    sa.Column('destination_name', sa.Text(), nullable=True),
    sa.Column('destination_address', sa.Text(), nullable=True),
    sa.Column('contact_person', sa.Text(), nullable=True),
    sa.Column('contact_phone', sa.Text(), nullable=True),
    sa.Column('delivery_time_slot', sa.Text(), nullable=True),
    sa.Column('tracking_number', sa.Text(), nullable=True),
    sa.Column('carrier', sa.Text(), nullable=True),
    sa.Column('carrier_service', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.String(length=50), nullable=True),
    sa.Column('updated_by', sa.String(length=50), nullable=True),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.Column('revision', sa.Integer(), server_default='1', nullable=False),
    sa.ForeignKeyConstraint(['lot_id'], ['lots.id'], ),
    sa.ForeignKeyConstraint(['order_line_id'], ['order_lines.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('allocations', schema=None) as batch_op:
        batch_op.add_column(sa.Column('allocation_date', sa.DateTime(), server_default=sa.text('now()'), nullable=True))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('order_line_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='受注明細ID（FK: order_lines.id）',
               existing_nullable=False)
        batch_op.alter_column('lot_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='ロットID（FK: lots.id）',
               existing_nullable=False)
        batch_op.alter_column('allocated_qty',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               type_=sa.Numeric(precision=15, scale=4),
               comment=None,
               existing_comment='引当数量',
               existing_nullable=False)
        batch_op.alter_column('destination_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='納入場所ID（FK: delivery_places.id）',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('ix_alloc_lot')
        batch_op.drop_index('ix_alloc_ol')
        batch_op.create_index('ix_allocations_lot', ['lot_id'], unique=False)
        batch_op.create_index('ix_allocations_order_line', ['order_line_id'], unique=False)
        batch_op.drop_constraint('allocations_lot_id_fkey', type_='foreignkey')
        batch_op.create_foreign_key(None, 'lots', ['lot_id'], ['id'])
        batch_op.drop_table_comment(
        existing_comment='受注明細へのロット引当情報'
    )

    with op.batch_alter_table('customers', schema=None) as batch_op:
        batch_op.alter_column('customer_code',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='得意先コード（PK/UK）',
               existing_nullable=False)
        batch_op.alter_column('customer_name',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='得意先名称',
               existing_nullable=False)
        batch_op.alter_column('address',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='住所',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('ix_customers_customer_code')
        batch_op.drop_constraint('uq_customers_customer_code', type_='unique')
        batch_op.drop_table_comment(
        existing_comment='得意先マスタ'
    )
        batch_op.drop_column('id')

    with op.batch_alter_table('delivery_places', schema=None) as batch_op:
        batch_op.add_column(sa.Column('place_code', sa.String(length=64), nullable=False))
        batch_op.add_column(sa.Column('place_name', sa.String(length=256), nullable=False))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('delivery_places_id_seq'::regclass)"))
        batch_op.alter_column('address',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               comment=None,
               existing_comment='住所',
               existing_nullable=True)
        batch_op.alter_column('is_active',
               existing_type=sa.BOOLEAN(),
               type_=sa.Integer(),
               comment=None,
               existing_comment='有効フラグ（1=有効,0=無効）',
               existing_nullable=False,
               existing_server_default=sa.text('true'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('ix_delivery_places_delivery_place_code')
        batch_op.drop_constraint('uq_delivery_places_code', type_='unique')
        batch_op.create_index(batch_op.f('ix_delivery_places_place_code'), ['place_code'], unique=True)
        batch_op.drop_table_comment(
        existing_comment='納入場所マスタ（配送先情報）'
    )
        batch_op.drop_column('postal_code')
        batch_op.drop_column('delivery_place_name')
        batch_op.drop_column('delivery_place_code')

    with op.batch_alter_table('expiry_rules', schema=None) as batch_op:
        batch_op.add_column(sa.Column('product_code', sa.Text(), nullable=False))
        batch_op.add_column(sa.Column('supplier_code', sa.Text(), nullable=False))
        batch_op.add_column(sa.Column('shelf_life_days', sa.Integer(), nullable=False))
        batch_op.add_column(sa.Column('warning_days', sa.Integer(), nullable=True))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.create_unique_constraint('uq_expiry_rule', ['product_code', 'supplier_code'])
        batch_op.drop_constraint('fk_expiry_rules_supplier', type_='foreignkey')
        batch_op.drop_constraint('fk_expiry_rules_product', type_='foreignkey')
        batch_op.create_foreign_key(None, 'products', ['product_code'], ['product_code'])
        batch_op.create_foreign_key(None, 'suppliers', ['supplier_code'], ['supplier_code'])
        batch_op.drop_table_comment(
        existing_comment='有効期限ルール定義（製品/仕入先ごと）'
    )
        batch_op.drop_column('days')
        batch_op.drop_column('fixed_date')
        batch_op.drop_column('supplier_id')
        batch_op.drop_column('rule_type')
        batch_op.drop_column('product_id')
        batch_op.drop_column('is_active')
        batch_op.drop_column('priority')

    with op.batch_alter_table('forecasts', schema=None) as batch_op:
        batch_op.add_column(sa.Column('supplier_id', sa.String(length=64), nullable=True))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('forecast_id',
               existing_type=sa.VARCHAR(length=36),
               type_=sa.Integer(),
               nullable=True,
               comment=None,
               existing_comment='外部予測ID（一意）')
        batch_op.alter_column('product_id',
               existing_type=sa.INTEGER(),
               type_=sa.String(length=64),
               comment=None,
               existing_comment='製品ID/または製品コード',
               existing_nullable=False)
        batch_op.alter_column('customer_id',
               existing_type=sa.INTEGER(),
               type_=sa.String(length=64),
               comment=None,
               existing_comment='得意先ID（FK: customers.*）/または得意先コード',
               existing_nullable=False)
        batch_op.alter_column('granularity',
               existing_type=sa.VARCHAR(length=16),
               comment=None,
               existing_comment='粒度（daily/weekly/dekadなど）',
               existing_nullable=False)
        batch_op.alter_column('date_day',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='日次キー（granularity=daily時）',
               existing_nullable=True)
        batch_op.alter_column('date_dekad_start',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='旬開始日キー（granularity=dekad時）',
               existing_nullable=True)
        batch_op.alter_column('year_month',
               existing_type=sa.VARCHAR(length=7),
               comment=None,
               existing_comment='月次キー（YYYY-MM, granularity=monthly時）',
               existing_nullable=True)
        batch_op.alter_column('qty_forecast',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='予測数量',
               existing_nullable=False)
        batch_op.alter_column('version_no',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='版番号（同一期間内の差替管理）',
               existing_nullable=False)
        batch_op.alter_column('version_issued_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment=None,
               existing_comment='版の発行日時（受信基準時刻）',
               existing_nullable=False)
        batch_op.alter_column('source_system',
               existing_type=sa.VARCHAR(length=32),
               comment=None,
               existing_comment='受信元システム識別子',
               existing_nullable=False)
        batch_op.alter_column('is_active',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='有効版フラグ',
               existing_nullable=False)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.create_index('idx_customer_product', ['customer_id', 'product_id'], unique=False)
        batch_op.drop_constraint('fk_forecasts_product', type_='foreignkey')
        batch_op.drop_constraint('fk_forecasts_customer', type_='foreignkey')
        batch_op.drop_table_comment(
        existing_comment='需要予測（DELFOR等のEDI受信データ）'
    )

    with op.batch_alter_table('inbound_submissions', schema=None) as batch_op:
        batch_op.add_column(sa.Column('source_file', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('schema_version', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('target_type', sa.Text(), nullable=True))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('submission_id',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='受信側の一意識別子（重複防止）',
               existing_nullable=True)
        batch_op.alter_column('source',
               existing_type=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='入力経路（ocr/manual/edi等）',
               existing_nullable=False,
               existing_server_default=sa.text("'ocr'::character varying"))
        batch_op.alter_column('operator',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='操作者（ユーザーIDまたはロボ名）',
               existing_nullable=True)
        batch_op.alter_column('submission_date',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='受信日時',
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='処理状態（pending/success/failed等）',
               existing_nullable=True)
        batch_op.alter_column('total_records',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='受信レコード総数',
               existing_nullable=True)
        batch_op.alter_column('processed_records',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='処理済み件数',
               existing_nullable=True)
        batch_op.alter_column('failed_records',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='失敗件数',
               existing_nullable=True)
        batch_op.alter_column('skipped_records',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='スキップ件数',
               existing_nullable=True)
        batch_op.alter_column('error_details',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='エラー詳細（テキスト/JSON可）',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード作成日時')
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_table_comment(
        existing_comment='外部入力の受信単位（OCR/EDI/手動等）のトラッキング'
    )
        batch_op.drop_column('source_uri')

    with op.batch_alter_table('lot_current_stock', schema=None) as batch_op:
        batch_op.alter_column('lot_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='ロットID（PK/FK: lots.id）',
               existing_nullable=False)
        batch_op.alter_column('current_quantity',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='現在庫数量（入庫-出庫-引当の計算結果）',
               existing_nullable=False)
        batch_op.alter_column('last_updated',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='最終更新日時',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_constraint('lot_current_stock_lot_id_fkey', type_='foreignkey')
        batch_op.create_foreign_key(None, 'lots', ['lot_id'], ['id'])
        batch_op.drop_table_comment(
        existing_comment='ロット別現在庫数（1ロット=1行の集計値）'
    )

    with op.batch_alter_table('lots', schema=None) as batch_op:
        batch_op.add_column(sa.Column('supplier_code', sa.Text(), nullable=False))
        batch_op.add_column(sa.Column('product_code', sa.Text(), nullable=False))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('lots_id_seq'::regclass)"))
        batch_op.alter_column('lot_number',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='ロット番号（手動/外部入力）',
               existing_nullable=False)
        batch_op.alter_column('receipt_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='入庫日',
               existing_nullable=False)
        batch_op.alter_column('mfg_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='製造日',
               existing_nullable=True)
        batch_op.alter_column('expiry_date',
               existing_type=sa.DATE(),
               comment=None,
               existing_comment='有効期限',
               existing_nullable=True)
        batch_op.alter_column('warehouse_id',
               existing_type=sa.INTEGER(),
               nullable=False,
               comment=None,
               existing_comment='保管倉庫ID（FK: warehouses.id）')
        batch_op.alter_column('kanban_class',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='かんばん区分',
               existing_nullable=True)
        batch_op.alter_column('received_by',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='入庫担当者',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード作成日時')
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード更新日時')
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.create_unique_constraint('uq_lot_supplier_product_no', ['supplier_code', 'product_code', 'lot_number'])
        batch_op.drop_constraint('fk_lots_warehouse_id__warehouses_id', type_='foreignkey')
        batch_op.drop_constraint('fk_lots_product', type_='foreignkey')
        batch_op.drop_constraint('fk_lots_supplier', type_='foreignkey')
        batch_op.create_foreign_key(None, 'suppliers', ['supplier_code'], ['supplier_code'])
        batch_op.create_foreign_key(None, 'warehouses', ['warehouse_id'], ['id'])
        batch_op.create_foreign_key(None, 'products', ['product_code'], ['product_code'])
        batch_op.drop_table_comment(
        existing_comment='ロットマスタ（入庫実績由来のトレーサビリティ情報）'
    )
        batch_op.drop_column('supplier_id')
        batch_op.drop_column('warehouse_code_old')
        batch_op.drop_column('product_id')

    with op.batch_alter_table('order_line_warehouse_allocation', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('order_line_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='受注明細ID（FK: order_lines.id）',
               existing_nullable=False)
        batch_op.alter_column('warehouse_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='倉庫ID（FK: warehouses.id）',
               existing_nullable=False)
        batch_op.alter_column('quantity',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               type_=sa.Numeric(precision=15, scale=4),
               comment=None,
               existing_comment='倉庫別引当数量',
               existing_nullable=False)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_constraint('uq_order_line_warehouse', type_='unique')
        batch_op.create_index('ix_olwa_order_line_id', ['order_line_id'], unique=False)
        batch_op.create_index('ix_olwa_warehouse_id', ['warehouse_id'], unique=False)
        batch_op.create_unique_constraint('uq_orderline_warehouse', ['order_line_id', 'warehouse_id'])
        batch_op.create_foreign_key(None, 'warehouses', ['warehouse_id'], ['id'])
        batch_op.drop_table_comment(
        existing_comment='受注明細×倉庫の引当（複数倉庫対応中間）'
    )

    with op.batch_alter_table('order_lines', schema=None) as batch_op:
        batch_op.add_column(sa.Column('product_code', sa.Text(), nullable=False))
        batch_op.add_column(sa.Column('status', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('delivery_date', sa.Date(), nullable=True))
        batch_op.add_column(sa.Column('forecast_id', sa.Integer(), nullable=True))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('order_lines_id_seq'::regclass)"))
        batch_op.alter_column('order_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='受注ID（FK: orders.id）',
               existing_nullable=False)
        batch_op.alter_column('line_no',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='明細行番号',
               existing_nullable=False)
        batch_op.alter_column('quantity',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               type_=sa.Numeric(precision=15, scale=4),
               comment=None,
               existing_comment='受注数量',
               existing_nullable=False)
        batch_op.alter_column('unit',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='単位',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード作成日時')
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.create_index('ix_order_lines_order_id', ['order_id'], unique=False)
        batch_op.create_index('ix_order_lines_product_code', ['product_code'], unique=False)
        batch_op.drop_constraint('fk_order_lines_product', type_='foreignkey')
        batch_op.create_foreign_key(None, 'forecasts', ['forecast_id'], ['id'])
        batch_op.create_foreign_key(None, 'products', ['product_code'], ['product_code'])
        batch_op.drop_table_comment(
        existing_comment='受注明細'
    )
        batch_op.drop_column('product_id')

    with op.batch_alter_table('orders', schema=None) as batch_op:
        batch_op.add_column(sa.Column('customer_code', sa.Text(), nullable=False))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('orders_id_seq'::regclass)"))
        batch_op.alter_column('order_no',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='受注番号（外部連携ID等）',
               existing_nullable=False)
        batch_op.alter_column('order_date',
               existing_type=sa.DATE(),
               nullable=True,
               comment=None,
               existing_comment='受注日')
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               nullable=True,
               comment=None,
               existing_comment='受注ステータス')
        batch_op.alter_column('sap_order_id',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='SAP側受注番号（登録後）',
               existing_nullable=True)
        batch_op.alter_column('sap_status',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='SAP連携状態',
               existing_nullable=True)
        batch_op.alter_column('sap_sent_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='SAP送信日時',
               existing_nullable=True)
        batch_op.alter_column('sap_error_msg',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='SAP連携エラー内容',
               existing_nullable=True)
        batch_op.alter_column('customer_order_no',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='先方注文番号（原票）',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード作成日時')
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード更新日時')
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('ix_orders_customer_id_order_date')
        batch_op.drop_index('uq_orders_customer_order_no_per_customer', postgresql_where='(customer_order_no IS NOT NULL)')
        batch_op.drop_constraint('fk_orders_customer', type_='foreignkey')
        batch_op.create_foreign_key(None, 'customers', ['customer_code'], ['customer_code'])
        batch_op.drop_table_comment(
        existing_comment='受注ヘッダ'
    )
        batch_op.drop_column('customer_id')

    with op.batch_alter_table('products', schema=None) as batch_op:
        batch_op.add_column(sa.Column('supplier_code', sa.Text(), nullable=True))
        batch_op.alter_column('product_code',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='製品コード（社内品番, PK/UK）',
               existing_nullable=False)
        batch_op.alter_column('product_name',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='製品名称',
               existing_nullable=False)
        batch_op.alter_column('packaging_qty',
               existing_type=sa.NUMERIC(precision=10, scale=2),
               type_=sa.Numeric(precision=15, scale=4),
               comment=None,
               existing_comment='包装数量（1箱あたり数量等）',
               existing_nullable=False,
               existing_server_default=sa.text("'1'::numeric"))
        batch_op.alter_column('packaging_unit',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.Text(),
               comment=None,
               existing_comment='包装単位',
               existing_nullable=False,
               existing_server_default=sa.text("'EA'::character varying"))
        batch_op.alter_column('internal_unit',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='内部管理単位（在庫基準単位）',
               existing_nullable=False)
        batch_op.alter_column('base_unit',
               existing_type=sa.VARCHAR(length=10),
               type_=sa.Text(),
               comment=None,
               existing_comment='基本単位（例: EA）',
               existing_nullable=False,
               existing_server_default=sa.text("'EA'::character varying"))
        batch_op.alter_column('customer_part_no',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='先方品番（得意先側品番）',
               existing_nullable=True)
        batch_op.alter_column('maker_item_code',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='メーカー品番（製造元品番）',
               existing_nullable=True)
        batch_op.alter_column('supplier_item_code',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               comment=None,
               existing_comment='仕入先側の品番',
               existing_nullable=True)
        batch_op.alter_column('assemble_div',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='組立区分（将来拡張）',
               existing_nullable=True)
        batch_op.alter_column('next_div',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='NEXT区分（得意先出荷時の区分、必要に応じ使用）',
               existing_nullable=True)
        batch_op.alter_column('ji_ku_text',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               comment=None,
               existing_comment='事業区分テキスト（任意メタ）',
               existing_nullable=True)
        batch_op.alter_column('kumitsuke_ku_text',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               comment=None,
               existing_comment='組付区分テキスト（任意メタ）',
               existing_nullable=True)
        batch_op.alter_column('shelf_life_days',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='想定賞味/有効日数',
               existing_nullable=True)
        batch_op.alter_column('requires_lot_number',
               existing_type=sa.INTEGER(),
               nullable=False,
               comment=None,
               existing_comment='ロット必須フラグ（0/1）')
        batch_op.alter_column('delivery_place_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='デフォルト納入場所ID（FK: delivery_places.id）',
               existing_nullable=True)
        batch_op.alter_column('delivery_place_name',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
        batch_op.alter_column('shipping_warehouse_name',
               existing_type=sa.VARCHAR(),
               type_=sa.Text(),
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('ix_products_product_code')
        batch_op.drop_constraint('uq_products_product_code', type_='unique')
        batch_op.drop_constraint('fk_products_supplier', type_='foreignkey')
        batch_op.create_foreign_key(None, 'suppliers', ['supplier_code'], ['supplier_code'])
        batch_op.drop_table_comment(
        existing_comment='商品マスタ'
    )
        batch_op.drop_column('id')
        batch_op.drop_column('supplier_id')

    with op.batch_alter_table('purchase_requests', schema=None) as batch_op:
        batch_op.add_column(sa.Column('product_code', sa.Text(), nullable=False))
        batch_op.add_column(sa.Column('supplier_code', sa.Text(), nullable=False))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('requested_qty',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               type_=sa.Numeric(precision=15, scale=4),
               comment=None,
               existing_comment='依頼数量',
               existing_nullable=False)
        batch_op.alter_column('requested_date',
               existing_type=sa.DATE(),
               nullable=False,
               comment=None,
               existing_comment='依頼日')
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='状態',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード作成日時')
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='レコード更新日時')
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_constraint('purchase_requests_src_order_line_id_fkey', type_='foreignkey')
        batch_op.drop_constraint('fk_purchase_requests_product', type_='foreignkey')
        batch_op.drop_constraint('fk_purchase_requests_supplier', type_='foreignkey')
        batch_op.create_foreign_key(None, 'products', ['product_code'], ['product_code'])
        batch_op.create_foreign_key(None, 'suppliers', ['supplier_code'], ['supplier_code'])
        batch_op.drop_table_comment(
        existing_comment='購買依頼（補充や手配の内部起票）'
    )
        batch_op.drop_column('sap_po_id')
        batch_op.drop_column('supplier_id')
        batch_op.drop_column('unit')
        batch_op.drop_column('desired_receipt_date')
        batch_op.drop_column('reason_code')
        batch_op.drop_column('product_id')
        batch_op.drop_column('notes')
        batch_op.drop_column('src_order_line_id')

    with op.batch_alter_table('sap_sync_logs', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('order_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='対象受注ID（FK: orders.id）',
               existing_nullable=True)
        batch_op.alter_column('payload',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='送信ペイロード（JSON文字列）',
               existing_nullable=True)
        batch_op.alter_column('result',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='応答内容（JSON文字列）',
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='連携状態（pending/success/failed/retry等）',
               existing_nullable=True)
        batch_op.alter_column('executed_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='連携実行日時',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_table_comment(
        existing_comment='SAP連携の実行ログ（送信ペイロードと結果）'
    )

    with op.batch_alter_table('stock_movements', schema=None) as batch_op:
        batch_op.add_column(sa.Column('movement_type', sa.Text(), nullable=False))
        batch_op.add_column(sa.Column('quantity', sa.Float(), nullable=False))
        batch_op.add_column(sa.Column('reference_doc_type', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('reference_doc_id', sa.Text(), nullable=True))
        batch_op.add_column(sa.Column('movement_date', sa.DateTime(), server_default=sa.text('now()'), nullable=False))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('lot_id',
               existing_type=sa.INTEGER(),
               nullable=False,
               comment=None,
               existing_comment='ロットID（FK: lots.id）')
        batch_op.alter_column('warehouse_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='倉庫ID（FK: warehouses.id）',
               existing_nullable=False)
        batch_op.alter_column('reason',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='移動理由（inbound/outbound/transfer/adjustment/scrap）',
               existing_nullable=False)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('idx_stock_movements_occurred_at')
        batch_op.drop_index('idx_stock_movements_product_warehouse')
        batch_op.drop_index('ix_stock_movements_lot')
        batch_op.create_index('ix_stock_movements_lot_date', ['lot_id', 'movement_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_movements_lot_id'), ['lot_id'], unique=False)
        batch_op.create_index('ix_stock_movements_warehouse_date', ['warehouse_id', 'movement_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_stock_movements_warehouse_id'), ['warehouse_id'], unique=False)
        batch_op.drop_constraint('stock_movements_warehouse_id_fkey', type_='foreignkey')
        batch_op.drop_constraint('fk_stock_movements_product', type_='foreignkey')
        batch_op.drop_constraint('stock_movements_lot_id_fkey', type_='foreignkey')
        batch_op.create_foreign_key(None, 'warehouses', ['warehouse_id'], ['id'])
        batch_op.create_foreign_key(None, 'lots', ['lot_id'], ['id'])
        batch_op.drop_table_comment(
        existing_comment='在庫移動履歴（入出庫/移動/調整/廃棄）'
    )
        batch_op.drop_column('occurred_at')
        batch_op.drop_column('source_table')
        batch_op.drop_column('product_id')
        batch_op.drop_column('source_id')
        batch_op.drop_column('quantity_delta')
        batch_op.drop_column('batch_id')

    with op.batch_alter_table('suppliers', schema=None) as batch_op:
        batch_op.alter_column('supplier_code',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='仕入先コード（PK/UK）',
               existing_nullable=False)
        batch_op.alter_column('supplier_name',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='仕入先名称',
               existing_nullable=False)
        batch_op.alter_column('address',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='住所',
               existing_nullable=True)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('ix_suppliers_supplier_code')
        batch_op.drop_constraint('uq_suppliers_supplier_code', type_='unique')
        batch_op.drop_table_comment(
        existing_comment='仕入先マスタ'
    )
        batch_op.drop_column('id')

    with op.batch_alter_table('unit_conversions', schema=None) as batch_op:
        batch_op.add_column(sa.Column('conversion_factor', sa.Float(), nullable=False))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('product_id',
               existing_type=sa.INTEGER(),
               type_=sa.Text(),
               nullable=True,
               comment=None,
               existing_comment='製品ID（FK: products.id / NULL=グローバル定義）')
        batch_op.alter_column('from_unit',
               existing_type=sa.VARCHAR(length=10),
               type_=sa.Text(),
               comment=None,
               existing_comment='変換元単位',
               existing_nullable=False)
        batch_op.alter_column('to_unit',
               existing_type=sa.VARCHAR(length=10),
               type_=sa.Text(),
               comment=None,
               existing_comment='変換先単位',
               existing_nullable=False)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_constraint('uq_product_units', type_='unique')
        batch_op.create_unique_constraint('uq_unit_conversion', ['product_id', 'from_unit', 'to_unit'])
        batch_op.drop_constraint('fk_unit_conversions_product', type_='foreignkey')
        batch_op.create_foreign_key(None, 'products', ['product_id'], ['product_code'])
        batch_op.drop_table_comment(
        existing_comment='単位換算マスタ（入出力単位 ⇔ 内部単位）'
    )
        batch_op.drop_column('factor')

    with op.batch_alter_table('warehouses', schema=None) as batch_op:
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.alter_column('warehouse_code',
               existing_type=sa.TEXT(),
               type_=sa.String(length=32),
               comment=None,
               existing_comment='倉庫コード（UK）',
               existing_nullable=False)
        batch_op.alter_column('warehouse_name',
               existing_type=sa.TEXT(),
               type_=sa.String(length=128),
               comment=None,
               existing_comment='倉庫名称',
               existing_nullable=False)
        batch_op.alter_column('address',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='住所',
               existing_nullable=True)
        batch_op.alter_column('is_active',
               existing_type=sa.BOOLEAN(),
               type_=sa.Integer(),
               nullable=True,
               comment=None,
               existing_comment='有効フラグ（1=有効,0=無効）',
               existing_server_default=sa.text('true'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.drop_index('uq_warehouses_id')
        batch_op.drop_constraint('uq_warehouses_warehouse_code', type_='unique')
        batch_op.create_index(batch_op.f('ix_warehouses_warehouse_code'), ['warehouse_code'], unique=True)
        batch_op.drop_table_comment(
        existing_comment='倉庫マスタ（保管拠点）'
    )

    # ### end Alembic commands ###
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('warehouses', schema=None) as batch_op:
        batch_op.create_table_comment(
        '倉庫マスタ（保管拠点）',
        existing_comment=None
    )
        batch_op.drop_index(batch_op.f('ix_warehouses_warehouse_code'))
        batch_op.create_unique_constraint('uq_warehouses_warehouse_code', ['warehouse_code'])
        batch_op.create_index('uq_warehouses_id', ['id'], unique=True)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('is_active',
               existing_type=sa.Integer(),
               type_=sa.BOOLEAN(),
               nullable=False,
               comment='有効フラグ（1=有効,0=無効）',
               existing_server_default=sa.text('true'))
        batch_op.alter_column('address',
               existing_type=sa.TEXT(),
               comment='住所',
               existing_nullable=True)
        batch_op.alter_column('warehouse_name',
               existing_type=sa.String(length=128),
               type_=sa.TEXT(),
               comment='倉庫名称',
               existing_nullable=False)
        batch_op.alter_column('warehouse_code',
               existing_type=sa.String(length=32),
               type_=sa.TEXT(),
               comment='倉庫コード（UK）',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)

    with op.batch_alter_table('unit_conversions', schema=None) as batch_op:
        batch_op.add_column(sa.Column('factor', sa.NUMERIC(precision=10, scale=4), autoincrement=False, nullable=False, comment='換算係数（1 from_unit = factor to_unit）'))
        batch_op.create_table_comment(
        '単位換算マスタ（入出力単位 ⇔ 内部単位）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_unit_conversions_product', 'products', ['product_id'], ['id'], ondelete='CASCADE')
        batch_op.drop_constraint('uq_unit_conversion', type_='unique')
        batch_op.create_unique_constraint('uq_product_units', ['product_id', 'from_unit', 'to_unit'])
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('to_unit',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(length=10),
               comment='変換先単位',
               existing_nullable=False)
        batch_op.alter_column('from_unit',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(length=10),
               comment='変換元単位',
               existing_nullable=False)
        batch_op.alter_column('product_id',
               existing_type=sa.Text(),
               type_=sa.INTEGER(),
               nullable=False,
               comment='製品ID（FK: products.id / NULL=グローバル定義）')
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('conversion_factor')

    with op.batch_alter_table('suppliers', schema=None) as batch_op:
        batch_op.add_column(sa.Column('id', sa.INTEGER(), server_default=sa.text("nextval('suppliers_id_seq'::regclass)"), autoincrement=True, nullable=False, comment='主キー（自動採番）'))
        batch_op.create_table_comment(
        '仕入先マスタ',
        existing_comment=None
    )
        batch_op.create_unique_constraint('uq_suppliers_supplier_code', ['supplier_code'])
        batch_op.create_index('ix_suppliers_supplier_code', ['supplier_code'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('address',
               existing_type=sa.TEXT(),
               comment='住所',
               existing_nullable=True)
        batch_op.alter_column('supplier_name',
               existing_type=sa.TEXT(),
               comment='仕入先名称',
               existing_nullable=False)
        batch_op.alter_column('supplier_code',
               existing_type=sa.TEXT(),
               comment='仕入先コード（PK/UK）',
               existing_nullable=False)

    with op.batch_alter_table('stock_movements', schema=None) as batch_op:
        batch_op.add_column(sa.Column('batch_id', sa.VARCHAR(length=100), autoincrement=False, nullable=True, comment='バッチ処理単位の識別子'))
        batch_op.add_column(sa.Column('quantity_delta', sa.NUMERIC(precision=15, scale=4), autoincrement=False, nullable=False, comment='数量増減（正=入庫、負=出庫）'))
        batch_op.add_column(sa.Column('source_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='参照元レコードID（追跡用）'))
        batch_op.add_column(sa.Column('product_id', sa.INTEGER(), autoincrement=False, nullable=False, comment='製品ID（FK候補：products.product_code/id）'))
        batch_op.add_column(sa.Column('source_table', sa.VARCHAR(length=50), autoincrement=False, nullable=True, comment='参照元テーブル名（追跡用）'))
        batch_op.add_column(sa.Column('occurred_at', postgresql.TIMESTAMP(), autoincrement=False, nullable=True, comment='発生日時'))
        batch_op.create_table_comment(
        '在庫移動履歴（入出庫/移動/調整/廃棄）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('stock_movements_lot_id_fkey', 'lots', ['lot_id'], ['id'], ondelete='CASCADE')
        batch_op.create_foreign_key('fk_stock_movements_product', 'products', ['product_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_foreign_key('stock_movements_warehouse_id_fkey', 'warehouses', ['warehouse_id'], ['id'], ondelete='RESTRICT')
        batch_op.drop_index(batch_op.f('ix_stock_movements_warehouse_id'))
        batch_op.drop_index('ix_stock_movements_warehouse_date')
        batch_op.drop_index(batch_op.f('ix_stock_movements_lot_id'))
        batch_op.drop_index('ix_stock_movements_lot_date')
        batch_op.create_index('ix_stock_movements_lot', ['lot_id'], unique=False)
        batch_op.create_index('idx_stock_movements_product_warehouse', ['product_id', 'warehouse_id'], unique=False)
        batch_op.create_index('idx_stock_movements_occurred_at', ['occurred_at'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('reason',
               existing_type=sa.TEXT(),
               comment='移動理由（inbound/outbound/transfer/adjustment/scrap）',
               existing_nullable=False)
        batch_op.alter_column('warehouse_id',
               existing_type=sa.INTEGER(),
               comment='倉庫ID（FK: warehouses.id）',
               existing_nullable=False)
        batch_op.alter_column('lot_id',
               existing_type=sa.INTEGER(),
               nullable=True,
               comment='ロットID（FK: lots.id）')
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('movement_date')
        batch_op.drop_column('reference_doc_id')
        batch_op.drop_column('reference_doc_type')
        batch_op.drop_column('quantity')
        batch_op.drop_column('movement_type')

    with op.batch_alter_table('sap_sync_logs', schema=None) as batch_op:
        batch_op.create_table_comment(
        'SAP連携の実行ログ（送信ペイロードと結果）',
        existing_comment=None
    )
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('executed_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='連携実行日時',
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               comment='連携状態（pending/success/failed/retry等）',
               existing_nullable=True)
        batch_op.alter_column('result',
               existing_type=sa.TEXT(),
               comment='応答内容（JSON文字列）',
               existing_nullable=True)
        batch_op.alter_column('payload',
               existing_type=sa.TEXT(),
               comment='送信ペイロード（JSON文字列）',
               existing_nullable=True)
        batch_op.alter_column('order_id',
               existing_type=sa.INTEGER(),
               comment='対象受注ID（FK: orders.id）',
               existing_nullable=True)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)

    with op.batch_alter_table('purchase_requests', schema=None) as batch_op:
        batch_op.add_column(sa.Column('src_order_line_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='起点受注明細ID（FK: order_lines.id）'))
        batch_op.add_column(sa.Column('notes', sa.TEXT(), autoincrement=False, nullable=True, comment='備考'))
        batch_op.add_column(sa.Column('product_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='製品ID（FK: products.id）'))
        batch_op.add_column(sa.Column('reason_code', sa.TEXT(), autoincrement=False, nullable=False, comment='依頼理由コード'))
        batch_op.add_column(sa.Column('desired_receipt_date', sa.DATE(), autoincrement=False, nullable=True, comment='希望入庫日'))
        batch_op.add_column(sa.Column('unit', sa.TEXT(), autoincrement=False, nullable=True, comment='単位'))
        batch_op.add_column(sa.Column('supplier_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='仕入先ID（FK: suppliers.id）'))
        batch_op.add_column(sa.Column('sap_po_id', sa.TEXT(), autoincrement=False, nullable=True, comment='SAP発注番号（連携後）'))
        batch_op.create_table_comment(
        '購買依頼（補充や手配の内部起票）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_purchase_requests_supplier', 'suppliers', ['supplier_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_foreign_key('fk_purchase_requests_product', 'products', ['product_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_foreign_key('purchase_requests_src_order_line_id_fkey', 'order_lines', ['src_order_line_id'], ['id'])
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード更新日時')
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード作成日時')
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               comment='状態',
               existing_nullable=True)
        batch_op.alter_column('requested_date',
               existing_type=sa.DATE(),
               nullable=True,
               comment='依頼日')
        batch_op.alter_column('requested_qty',
               existing_type=sa.Numeric(precision=15, scale=4),
               type_=sa.DOUBLE_PRECISION(precision=53),
               comment='依頼数量',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('supplier_code')
        batch_op.drop_column('product_code')

    with op.batch_alter_table('products', schema=None) as batch_op:
        batch_op.add_column(sa.Column('supplier_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='主要仕入先ID（FK: suppliers.id）'))
        batch_op.add_column(sa.Column('id', sa.INTEGER(), server_default=sa.text("nextval('products_id_seq'::regclass)"), autoincrement=True, nullable=False, comment='主キー（自動採番）'))
        batch_op.create_table_comment(
        '商品マスタ',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_products_supplier', 'suppliers', ['supplier_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_unique_constraint('uq_products_product_code', ['product_code'])
        batch_op.create_index('ix_products_product_code', ['product_code'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('shipping_warehouse_name',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
        batch_op.alter_column('delivery_place_name',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               existing_nullable=True)
        batch_op.alter_column('delivery_place_id',
               existing_type=sa.INTEGER(),
               comment='デフォルト納入場所ID（FK: delivery_places.id）',
               existing_nullable=True)
        batch_op.alter_column('requires_lot_number',
               existing_type=sa.INTEGER(),
               nullable=True,
               comment='ロット必須フラグ（0/1）')
        batch_op.alter_column('shelf_life_days',
               existing_type=sa.INTEGER(),
               comment='想定賞味/有効日数',
               existing_nullable=True)
        batch_op.alter_column('kumitsuke_ku_text',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               comment='組付区分テキスト（任意メタ）',
               existing_nullable=True)
        batch_op.alter_column('ji_ku_text',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               comment='事業区分テキスト（任意メタ）',
               existing_nullable=True)
        batch_op.alter_column('next_div',
               existing_type=sa.TEXT(),
               comment='NEXT区分（得意先出荷時の区分、必要に応じ使用）',
               existing_nullable=True)
        batch_op.alter_column('assemble_div',
               existing_type=sa.TEXT(),
               comment='組立区分（将来拡張）',
               existing_nullable=True)
        batch_op.alter_column('supplier_item_code',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               comment='仕入先側の品番',
               existing_nullable=True)
        batch_op.alter_column('maker_item_code',
               existing_type=sa.TEXT(),
               comment='メーカー品番（製造元品番）',
               existing_nullable=True)
        batch_op.alter_column('customer_part_no',
               existing_type=sa.TEXT(),
               comment='先方品番（得意先側品番）',
               existing_nullable=True)
        batch_op.alter_column('base_unit',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(length=10),
               comment='基本単位（例: EA）',
               existing_nullable=False,
               existing_server_default=sa.text("'EA'::character varying"))
        batch_op.alter_column('internal_unit',
               existing_type=sa.TEXT(),
               comment='内部管理単位（在庫基準単位）',
               existing_nullable=False)
        batch_op.alter_column('packaging_unit',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(length=20),
               comment='包装単位',
               existing_nullable=False,
               existing_server_default=sa.text("'EA'::character varying"))
        batch_op.alter_column('packaging_qty',
               existing_type=sa.Numeric(precision=15, scale=4),
               type_=sa.NUMERIC(precision=10, scale=2),
               comment='包装数量（1箱あたり数量等）',
               existing_nullable=False,
               existing_server_default=sa.text("'1'::numeric"))
        batch_op.alter_column('product_name',
               existing_type=sa.TEXT(),
               comment='製品名称',
               existing_nullable=False)
        batch_op.alter_column('product_code',
               existing_type=sa.TEXT(),
               comment='製品コード（社内品番, PK/UK）',
               existing_nullable=False)
        batch_op.drop_column('supplier_code')

    with op.batch_alter_table('orders', schema=None) as batch_op:
        batch_op.add_column(sa.Column('customer_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='得意先ID（FK: customers.id）'))
        batch_op.create_table_comment(
        '受注ヘッダ',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_orders_customer', 'customers', ['customer_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_index('uq_orders_customer_order_no_per_customer', ['customer_id', 'customer_order_no'], unique=True, postgresql_where='(customer_order_no IS NOT NULL)')
        batch_op.create_index('ix_orders_customer_id_order_date', ['customer_id', 'order_date'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード更新日時')
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード作成日時')
        batch_op.alter_column('customer_order_no',
               existing_type=sa.TEXT(),
               comment='先方注文番号（原票）',
               existing_nullable=True)
        batch_op.alter_column('sap_error_msg',
               existing_type=sa.TEXT(),
               comment='SAP連携エラー内容',
               existing_nullable=True)
        batch_op.alter_column('sap_sent_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='SAP送信日時',
               existing_nullable=True)
        batch_op.alter_column('sap_status',
               existing_type=sa.TEXT(),
               comment='SAP連携状態',
               existing_nullable=True)
        batch_op.alter_column('sap_order_id',
               existing_type=sa.TEXT(),
               comment='SAP側受注番号（登録後）',
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               nullable=False,
               comment='受注ステータス')
        batch_op.alter_column('order_date',
               existing_type=sa.DATE(),
               nullable=False,
               comment='受注日')
        batch_op.alter_column('order_no',
               existing_type=sa.TEXT(),
               comment='受注番号（外部連携ID等）',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('orders_id_seq'::regclass)"))
        batch_op.drop_column('customer_code')

    with op.batch_alter_table('order_lines', schema=None) as batch_op:
        batch_op.add_column(sa.Column('product_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='製品ID（将来変更用：FK想定）'))
        batch_op.create_table_comment(
        '受注明細',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_order_lines_product', 'products', ['product_id'], ['id'], ondelete='RESTRICT')
        batch_op.drop_index('ix_order_lines_product_code')
        batch_op.drop_index('ix_order_lines_order_id')
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード作成日時')
        batch_op.alter_column('unit',
               existing_type=sa.TEXT(),
               comment='単位',
               existing_nullable=True)
        batch_op.alter_column('quantity',
               existing_type=sa.Numeric(precision=15, scale=4),
               type_=sa.DOUBLE_PRECISION(precision=53),
               comment='受注数量',
               existing_nullable=False)
        batch_op.alter_column('line_no',
               existing_type=sa.INTEGER(),
               comment='明細行番号',
               existing_nullable=False)
        batch_op.alter_column('order_id',
               existing_type=sa.INTEGER(),
               comment='受注ID（FK: orders.id）',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('order_lines_id_seq'::regclass)"))
        batch_op.drop_column('forecast_id')
        batch_op.drop_column('delivery_date')
        batch_op.drop_column('status')
        batch_op.drop_column('product_code')

    with op.batch_alter_table('order_line_warehouse_allocation', schema=None) as batch_op:
        batch_op.create_table_comment(
        '受注明細×倉庫の引当（複数倉庫対応中間）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint('uq_orderline_warehouse', type_='unique')
        batch_op.drop_index('ix_olwa_warehouse_id')
        batch_op.drop_index('ix_olwa_order_line_id')
        batch_op.create_unique_constraint('uq_order_line_warehouse', ['order_line_id', 'warehouse_id'])
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('quantity',
               existing_type=sa.Numeric(precision=15, scale=4),
               type_=sa.DOUBLE_PRECISION(precision=53),
               comment='倉庫別引当数量',
               existing_nullable=False)
        batch_op.alter_column('warehouse_id',
               existing_type=sa.INTEGER(),
               comment='倉庫ID（FK: warehouses.id）',
               existing_nullable=False)
        batch_op.alter_column('order_line_id',
               existing_type=sa.INTEGER(),
               comment='受注明細ID（FK: order_lines.id）',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)

    with op.batch_alter_table('lots', schema=None) as batch_op:
        batch_op.add_column(sa.Column('product_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='製品ID（FK: products.id）'))
        batch_op.add_column(sa.Column('warehouse_code_old', sa.TEXT(), autoincrement=False, nullable=True))
        batch_op.add_column(sa.Column('supplier_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='仕入先ID（FK: suppliers.id）'))
        batch_op.create_table_comment(
        'ロットマスタ（入庫実績由来のトレーサビリティ情報）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_lots_supplier', 'suppliers', ['supplier_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_foreign_key('fk_lots_product', 'products', ['product_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_foreign_key('fk_lots_warehouse_id__warehouses_id', 'warehouses', ['warehouse_id'], ['id'], ondelete='RESTRICT')
        batch_op.drop_constraint('uq_lot_supplier_product_no', type_='unique')
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード更新日時')
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード作成日時')
        batch_op.alter_column('received_by',
               existing_type=sa.TEXT(),
               comment='入庫担当者',
               existing_nullable=True)
        batch_op.alter_column('kanban_class',
               existing_type=sa.TEXT(),
               comment='かんばん区分',
               existing_nullable=True)
        batch_op.alter_column('warehouse_id',
               existing_type=sa.INTEGER(),
               nullable=True,
               comment='保管倉庫ID（FK: warehouses.id）')
        batch_op.alter_column('expiry_date',
               existing_type=sa.DATE(),
               comment='有効期限',
               existing_nullable=True)
        batch_op.alter_column('mfg_date',
               existing_type=sa.DATE(),
               comment='製造日',
               existing_nullable=True)
        batch_op.alter_column('receipt_date',
               existing_type=sa.DATE(),
               comment='入庫日',
               existing_nullable=False)
        batch_op.alter_column('lot_number',
               existing_type=sa.TEXT(),
               comment='ロット番号（手動/外部入力）',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('lots_id_seq'::regclass)"))
        batch_op.drop_column('product_code')
        batch_op.drop_column('supplier_code')

    with op.batch_alter_table('lot_current_stock', schema=None) as batch_op:
        batch_op.create_table_comment(
        'ロット別現在庫数（1ロット=1行の集計値）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('lot_current_stock_lot_id_fkey', 'lots', ['lot_id'], ['id'], ondelete='CASCADE')
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('last_updated',
               existing_type=postgresql.TIMESTAMP(),
               comment='最終更新日時',
               existing_nullable=True)
        batch_op.alter_column('current_quantity',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='現在庫数量（入庫-出庫-引当の計算結果）',
               existing_nullable=False)
        batch_op.alter_column('lot_id',
               existing_type=sa.INTEGER(),
               comment='ロットID（PK/FK: lots.id）',
               existing_nullable=False)

    with op.batch_alter_table('inbound_submissions', schema=None) as batch_op:
        batch_op.add_column(sa.Column('source_uri', sa.TEXT(), autoincrement=False, nullable=True, comment='受信ソースURI（ファイル名/パス/URL等）'))
        batch_op.create_table_comment(
        '外部入力の受信単位（OCR/EDI/手動等）のトラッキング',
        existing_comment=None
    )
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='レコード作成日時')
        batch_op.alter_column('error_details',
               existing_type=sa.TEXT(),
               comment='エラー詳細（テキスト/JSON可）',
               existing_nullable=True)
        batch_op.alter_column('skipped_records',
               existing_type=sa.INTEGER(),
               comment='スキップ件数',
               existing_nullable=True)
        batch_op.alter_column('failed_records',
               existing_type=sa.INTEGER(),
               comment='失敗件数',
               existing_nullable=True)
        batch_op.alter_column('processed_records',
               existing_type=sa.INTEGER(),
               comment='処理済み件数',
               existing_nullable=True)
        batch_op.alter_column('total_records',
               existing_type=sa.INTEGER(),
               comment='受信レコード総数',
               existing_nullable=True)
        batch_op.alter_column('status',
               existing_type=sa.TEXT(),
               comment='処理状態（pending/success/failed等）',
               existing_nullable=True)
        batch_op.alter_column('submission_date',
               existing_type=postgresql.TIMESTAMP(),
               comment='受信日時',
               existing_nullable=True)
        batch_op.alter_column('operator',
               existing_type=sa.TEXT(),
               comment='操作者（ユーザーIDまたはロボ名）',
               existing_nullable=True)
        batch_op.alter_column('source',
               existing_type=sa.VARCHAR(length=20),
               comment='入力経路（ocr/manual/edi等）',
               existing_nullable=False,
               existing_server_default=sa.text("'ocr'::character varying"))
        batch_op.alter_column('submission_id',
               existing_type=sa.TEXT(),
               comment='受信側の一意識別子（重複防止）',
               existing_nullable=True)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('target_type')
        batch_op.drop_column('schema_version')
        batch_op.drop_column('source_file')

    with op.batch_alter_table('forecasts', schema=None) as batch_op:
        batch_op.create_table_comment(
        '需要予測（DELFOR等のEDI受信データ）',
        existing_comment=None
    )
        batch_op.create_foreign_key('fk_forecasts_customer', 'customers', ['customer_id'], ['id'], ondelete='RESTRICT')
        batch_op.create_foreign_key('fk_forecasts_product', 'products', ['product_id'], ['id'], ondelete='RESTRICT')
        batch_op.drop_index('idx_customer_product')
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               comment='レコード更新日時',
               existing_nullable=False)
        batch_op.alter_column('created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               comment='レコード作成日時',
               existing_nullable=False)
        batch_op.alter_column('is_active',
               existing_type=sa.BOOLEAN(),
               comment='有効版フラグ',
               existing_nullable=False)
        batch_op.alter_column('source_system',
               existing_type=sa.VARCHAR(length=32),
               comment='受信元システム識別子',
               existing_nullable=False)
        batch_op.alter_column('version_issued_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               comment='版の発行日時（受信基準時刻）',
               existing_nullable=False)
        batch_op.alter_column('version_no',
               existing_type=sa.INTEGER(),
               comment='版番号（同一期間内の差替管理）',
               existing_nullable=False)
        batch_op.alter_column('qty_forecast',
               existing_type=sa.INTEGER(),
               comment='予測数量',
               existing_nullable=False)
        batch_op.alter_column('year_month',
               existing_type=sa.VARCHAR(length=7),
               comment='月次キー（YYYY-MM, granularity=monthly時）',
               existing_nullable=True)
        batch_op.alter_column('date_dekad_start',
               existing_type=sa.DATE(),
               comment='旬開始日キー（granularity=dekad時）',
               existing_nullable=True)
        batch_op.alter_column('date_day',
               existing_type=sa.DATE(),
               comment='日次キー（granularity=daily時）',
               existing_nullable=True)
        batch_op.alter_column('granularity',
               existing_type=sa.VARCHAR(length=16),
               comment='粒度（daily/weekly/dekadなど）',
               existing_nullable=False)
        batch_op.alter_column('customer_id',
               existing_type=sa.String(length=64),
               type_=sa.INTEGER(),
               comment='得意先ID（FK: customers.*）/または得意先コード',
               existing_nullable=False)
        batch_op.alter_column('product_id',
               existing_type=sa.String(length=64),
               type_=sa.INTEGER(),
               comment='製品ID/または製品コード',
               existing_nullable=False)
        batch_op.alter_column('forecast_id',
               existing_type=sa.Integer(),
               type_=sa.VARCHAR(length=36),
               nullable=False,
               comment='外部予測ID（一意）')
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('supplier_id')

    with op.batch_alter_table('expiry_rules', schema=None) as batch_op:
        batch_op.add_column(sa.Column('priority', sa.INTEGER(), autoincrement=False, nullable=False, comment='優先順位（小さいほど優先）'))
        batch_op.add_column(sa.Column('is_active', sa.BOOLEAN(), server_default=sa.text('true'), autoincrement=False, nullable=False, comment='有効フラグ'))
        batch_op.add_column(sa.Column('product_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='製品ID（FK: products.id / NULL=全製品）'))
        batch_op.add_column(sa.Column('rule_type', sa.TEXT(), autoincrement=False, nullable=False, comment='ルール種別（days/fixed_date）'))
        batch_op.add_column(sa.Column('supplier_id', sa.INTEGER(), autoincrement=False, nullable=True, comment='仕入先ID（FK: suppliers.id / NULL=全仕入先）'))
        batch_op.add_column(sa.Column('fixed_date', sa.DATE(), autoincrement=False, nullable=True, comment='固定日付'))
        batch_op.add_column(sa.Column('days', sa.INTEGER(), autoincrement=False, nullable=True, comment='有効日数（製造日から）'))
        batch_op.create_table_comment(
        '有効期限ルール定義（製品/仕入先ごと）',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('fk_expiry_rules_product', 'products', ['product_id'], ['id'], ondelete='SET NULL')
        batch_op.create_foreign_key('fk_expiry_rules_supplier', 'suppliers', ['supplier_id'], ['id'], ondelete='SET NULL')
        batch_op.drop_constraint('uq_expiry_rule', type_='unique')
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('warning_days')
        batch_op.drop_column('shelf_life_days')
        batch_op.drop_column('supplier_code')
        batch_op.drop_column('product_code')

    with op.batch_alter_table('delivery_places', schema=None) as batch_op:
        batch_op.add_column(sa.Column('delivery_place_code', sa.VARCHAR(), autoincrement=False, nullable=False, comment='納入場所コード（UK）'))
        batch_op.add_column(sa.Column('delivery_place_name', sa.VARCHAR(), autoincrement=False, nullable=False, comment='納入場所名称'))
        batch_op.add_column(sa.Column('postal_code', sa.VARCHAR(), autoincrement=False, nullable=True, comment='郵便番号'))
        batch_op.create_table_comment(
        '納入場所マスタ（配送先情報）',
        existing_comment=None
    )
        batch_op.drop_index(batch_op.f('ix_delivery_places_place_code'))
        batch_op.create_unique_constraint('uq_delivery_places_code', ['delivery_place_code'])
        batch_op.create_index('ix_delivery_places_delivery_place_code', ['delivery_place_code'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('is_active',
               existing_type=sa.Integer(),
               type_=sa.BOOLEAN(),
               comment='有効フラグ（1=有効,0=無効）',
               existing_nullable=False,
               existing_server_default=sa.text('true'))
        batch_op.alter_column('address',
               existing_type=sa.Text(),
               type_=sa.VARCHAR(),
               comment='住所',
               existing_nullable=True)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True,
               existing_server_default=sa.text("nextval('delivery_places_id_seq'::regclass)"))
        batch_op.drop_column('place_name')
        batch_op.drop_column('place_code')

    with op.batch_alter_table('customers', schema=None) as batch_op:
        batch_op.add_column(sa.Column('id', sa.INTEGER(), server_default=sa.text("nextval('customers_id_seq'::regclass)"), autoincrement=True, nullable=False, comment='主キー（自動採番）'))
        batch_op.create_table_comment(
        '得意先マスタ',
        existing_comment=None
    )
        batch_op.create_unique_constraint('uq_customers_customer_code', ['customer_code'])
        batch_op.create_index('ix_customers_customer_code', ['customer_code'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('address',
               existing_type=sa.TEXT(),
               comment='住所',
               existing_nullable=True)
        batch_op.alter_column('customer_name',
               existing_type=sa.TEXT(),
               comment='得意先名称',
               existing_nullable=False)
        batch_op.alter_column('customer_code',
               existing_type=sa.TEXT(),
               comment='得意先コード（PK/UK）',
               existing_nullable=False)

    with op.batch_alter_table('allocations', schema=None) as batch_op:
        batch_op.create_table_comment(
        '受注明細へのロット引当情報',
        existing_comment=None
    )
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('allocations_lot_id_fkey', 'lots', ['lot_id'], ['id'], ondelete='CASCADE')
        batch_op.drop_index('ix_allocations_order_line')
        batch_op.drop_index('ix_allocations_lot')
        batch_op.create_index('ix_alloc_ol', ['order_line_id'], unique=False)
        batch_op.create_index('ix_alloc_lot', ['lot_id'], unique=False)
        batch_op.alter_column('revision',
               existing_type=sa.INTEGER(),
               comment='楽観的ロック用リビジョン番号',
               existing_nullable=False,
               existing_server_default=sa.text('1'))
        batch_op.alter_column('deleted_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='論理削除日時',
               existing_nullable=True)
        batch_op.alter_column('updated_by',
               existing_type=sa.VARCHAR(length=50),
               comment='更新者',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.VARCHAR(length=50),
               comment='作成者',
               existing_nullable=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード更新日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='レコード作成日時',
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
        batch_op.alter_column('destination_id',
               existing_type=sa.INTEGER(),
               comment='納入場所ID（FK: delivery_places.id）',
               existing_nullable=True)
        batch_op.alter_column('allocated_qty',
               existing_type=sa.Numeric(precision=15, scale=4),
               type_=sa.DOUBLE_PRECISION(precision=53),
               comment='引当数量',
               existing_nullable=False)
        batch_op.alter_column('lot_id',
               existing_type=sa.INTEGER(),
               comment='ロットID（FK: lots.id）',
               existing_nullable=False)
        batch_op.alter_column('order_line_id',
               existing_type=sa.INTEGER(),
               comment='受注明細ID（FK: order_lines.id）',
               existing_nullable=False)
        batch_op.alter_column('id',
               existing_type=sa.INTEGER(),
               comment='主キー（自動採番）',
               existing_nullable=False,
               autoincrement=True)
        batch_op.drop_column('allocation_date')

    op.drop_table('shipping')
    with op.batch_alter_table('receipt_lines', schema=None) as batch_op:
        batch_op.drop_index('ix_receipt_lines_lot')

    op.drop_table('receipt_lines')
    op.drop_table('product_uom_conversions')
    with op.batch_alter_table('receipt_headers', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_receipt_headers_warehouse_id'))

    op.drop_table('receipt_headers')
    op.drop_table('next_div_map')
    # ### end Alembic commands ###
    # ### end Alembic commands ###
